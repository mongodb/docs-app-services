.. _realm-event-library:

===================
Realm Event Library
===================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

The Realm Event Library enables developers to track what data the user 
sees and edits while using a Realm Sync-enabled mobile application. The 
Event Library can record three types of events:

- Read events
- Write events
- Custom events

Developers can specify the read and write transactions they want to record.
Additionally, you can configure custom events to record things like 
button presses, or what the user is seeing in the frontend application.

This level of detail enables auditors or other interested parties to
assess exactly what happened, and when.

Use Case
~~~~~~~~

The Event Library provides the ability to perform audits to meet compliance
requirements in heavily-regulated industries, such as healthcare or 
financial services.

.. example::

   A nurse in a healthcare facility uses an app with the Event Library 
   enabled. The app presents the nurse with real-time vital signs, 
   information streamed in from the medical equipment, and the patient's
   historical treatment information. The app inherently enforces compliance,
   because its code blocks actions that the nurse should not take based
   on the data being viewed. The Event Library captures all the information
   that the nurse sees within the app interface, as well as the actions 
   that the nurse takes after viewing that information.
   
   At some point, this nurse provides treatment to a patient that later 
   exposes the facility to a malpractice lawsuit. The legal department
   must review the information that was available to the nurse during the
   treatment. 
   
   The Event Library captures the digital data that the nurse 
   viewed during treatment, as well as the actions he undertook. By 
   reviewing this data, the legal team can assess whether the treatment was 
   reasonable. Without this information, the legal department can't know
   and prove whether the nurse's actions were reasonable.

How It Works
~~~~~~~~~~~~

The Event Library opens a separate "event" realm on the user's device. This 
realm has access to any user realm that the developer chooses to monitor
with the Event Library.

When developers implement the Event Library, they designate the types of 
events they want to record, as well as any custom metadata they want to 
append to the event recordings. When the client application runs, it records
the designated user interactions to the "event" realm as read events, 
write events, or custom events. 

While the client device has a network connection, {+sync+} synchronizes 
this event realm data to an ``AuditEvent`` collection in the linked Atlas 
data source.

.. seealso::

   For information on how to implement the Event Library in a client 
   application, see: :ref:`Event Library - Swift SDK <swift-event-library>`.

Access Event Library Data
-------------------------

The Event Library records event data in a collection called ``AuditEvent`` 
in your linked Atlas database. You must create an ``AuditEvent`` collection
before you use the Event Library to record client application events.

.. seealso::

   For information on how to create a collection, see: :ref:`Create a 
   Collection - Atlas UI <atlas-ui-create-a-collection>`.

Event Library Schema
~~~~~~~~~~~~~~~~~~~~

Your ``AuditEvent`` collection must have a schema containing the following
fields:

.. list-table::

   * - ``_id``
     - ``activity``
     - ``_partition``
     - ``timestamp``
     - ``event``
     - ``data``

   * - ObjectId
     - String
     - String
     - String
     - String
     - String

   * - Required
     - Required
     - Required
     - Required
     - Optional
     - Optional

Additionally, the schema must contain an optional string field
for each metadata key you use. For example:

.. code-block:: json

   { 
     "<Metadata Key>": { 
       "bsonType": "string" 
     } 
   }

.. seealso::

   For information on how to add a schema to your collection, see: 
   :ref:`Enforce a Schema <enforce-a-schema>`.

.. example::

   If you're not using any custom metadata, your schema might look like this:

   .. code-block:: json
      :caption: AuditEvent Collection Schema

      {
        "title": "AuditEvent",
        "bsonType": "object",
        "required": [
          "_id",
          "_partition",
          "activity",
          "timestamp"
        ],
        "properties": {
          "_id": {
            "bsonType": "objectId"
          },
          "_partition": {
            "bsonType": "string"
          },
          "activity": {
            "bsonType": "string"
          },
          "data": {
            "bsonType": "string"
          },
          "event": {
            "bsonType": "string"
          },
          "timestamp": {
            "bsonType": "string"
          }
        }
      }

Event Types
-----------

The Event Library records three types of events:

- Read events
- Write events
- Custom events

.. _event-library-read-events:

Read Events
~~~~~~~~~~~

The Event Library records data returned as the result of a query as read 
events. Read events also record any time a Realm object is instantiated, 
such as when following a link or looking an object up by primary key.

The Event Library records read events as a JSON object with two fields:

- ``type``: stores the class name
- ``value``: stores an array of serialized objects

Read events store values as follows:

- *Single-object read events*: the value is an array that has a single element
- *Objects matching a query*: the value is an array of all objects matching
  a query, even if the objects are never used
- *Reads that occur during a write transaction*: the value is the data that
  the object has before the write transaction began; it does not reflect
  any changes that occur during the write event.
- *Objects that do not exist when a write transaction begins*: objects that
  are created in a write transaction do not produce a read event at all.

.. important::

   The Event Library cannot tell if only a subset of the query displays in 
   the client application. For example, say the client application has a 
   list view. The Event Library's read event doesn't record scrolling 
   information; it records the read event as the full query result. 
   Developers must use custom events to record when a client application 
   displays only a subset of a query result.

Read Event Combining
````````````````````

A stream of every read event could produce a lot of "duplicate" events on
the same objects that don't add information. To reduce these "duplicate" 
events, the Event Library discards and merges some events.

The Event Library discards:

- Queries which match no objects
- Queries which match only newly-created objects
- Object reads where the object is matched by a previous query

The Event Library merges:

- Multiple queries on the same table into a single merged query.

Read Event Format
`````````````````

A read event object has this format:

.. code-block:: json

   {
     "type": "ClassName",
     "value": [{
       "_id": "1-2-3",
       "str": "abc"
     }]
   }

Embedded Object Read Events
```````````````````````````

The Event Library represents embedded objects by creating a link in the 
parent object to the primary key of the embedded object. When the user
does not follow the link, the primary key is the only representation of
the embedded object. When the user does follow the link, the embedded 
object resolves within the parent object.

This also produces a top-level object read.

.. example::

   .. code-block:: json
      :caption: Parent Object with an Unfollowed Link
   
      {
        "type": "Person",
        "value": [{
          "_id": "1-2-3",
          "name": "Frodo Baggins",
          "address": "4-5-6"
        }]
      }

   .. code-block:: json
      :caption: Parent Object with a Followed Link
   
      {
        "type": "Person",
        "value": [{
          "_id": "1-2-3",
          "name": "Frodo Baggins",
          "address": [{
            "_id": "4-5-6",
            "street": "1 Bag End",
            "city": "Hobbiton Hill",
            "state": "The Shire"
          }]
        }]
      }

.. _event-library-write-events:

Write Events
~~~~~~~~~~~~

The Event Library records write events when:

- New objects are created
- Existing objects are modified
- Objects are deleted

The write event records both the before and after state of the object. For
new objects created, the before state is ``null``. For deletes, the after
state of the object is ``null``. 

For each write transaction the client commits during an event recording 
scope, the Event Library records a single write event. This write event
records all of the changes made during the write transaction.

The payload is an object keyed on class names. Each object type which had
any objects created, modified, or deleted has an entry.

The Event Library records changes to an object type as an object with three 
arrays:

- insertions: contain the serialized objects which were inserted, using the 
  same serialization scheme as reads
- modifications: report both the old and new values of each property
- deletions: contain the serialized objects which were deleted, using the 
  same serialization scheme as reads

In a modification, the ``newValue`` object only includes properties which
are different from the ``oldValue`` object. If a write transaction assigns
to an object but does not actually change the value of any properties, 

Write Event Format
``````````````````

A write event object has this format:

.. code-block:: json

   {
     "ClassName 1": {
       "insertions": [
         {"_id", "new object id", "foo": "new object value"}
       ],
       "modifications": [
         {
           "oldValue": {
             "_id": "object id",
             "foo": "old property value"
           },
           "newValue": {
             "foo": "new property value"
           }
         }
       ],
       "deletions": [
         {"_id", "deleted object id", "foo": "property value of object before deletion"}
       ],
     },
     "ClassName 2": {
       "insertions": [
         {"_id", "new object id", "bar": "new object value"}
       ],
     }
   }

.. _event-library-custom-events:

Custom Events
~~~~~~~~~~~~~

Custom events can record types of events that do not read or write to the 
database, such as:

- When a specific screen displays
- When the user clicks a button

You can use custom events to give context to read and write events, such 
as recording a custom event when the client application displays a given 
screen. Then, you can infer that read and write events after the custom 
event recording the app screen loading all occurred on that app screen.

Custom events can store whatever data a developer desires, or no data at all.
