.. _enable-realm-sync:
.. _enable-sync:
.. _alter-your-sync-configuration:

======================================
Configure and Enable Atlas Device Sync
======================================

.. default-domain:: mongodb

..
   Note: Depth is "1" to avoid headings within tabs

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

You can configure and enable Atlas Device Sync via the App Services UI, {+cli+}, or
the Atlas App Services Admin API. You can update an existing configuration in
the same way. If it is your first time enabling Device Sync, the UI is a great
choice because it walks you through the required steps.

You might want to alter your Atlas Device Sync configuration after you have
already enabled Device Sync. You can update a configuration using the same
procedure as enabling Device Sync in the first place. If you're using Flexible
Sync mode, you can update your configuration without needing to terminate and
re-enable Sync.

If you're re-enabling Device Sync after pausing or terminating it, refer to
:ref:`Resume <resume-sync>` or :ref:`Re-Enable <re-enable-realm-sync>` Device
Sync.

If you are using the older Partition-Based Sync mode, refer to
:ref:`alter-partition-based-sync-config`.

Prerequisites
-------------

While you are configuring Device Sync, you must define the data access patterns
and rules for your App. If you haven't already decided how you want to
configure your data model and access Device Sync, see:

- :ref:`Configure Your Data Model <sync-schema-overview>`
- :ref:`Sync Rules and Permissions <sync-permissions>`

.. important::
   
   Before defining sync rules and enabling sync, you must specify at least
   one valid :ref:`schema <schemas>` for a collection in the synced cluster 
   unless you are using :ref:`Development Mode <development-mode>`.
   
   At a minimum, the schema must define ``_id`` and the field(s)
   you intend to use as your :ref:`queryable fields <queryable-fields>`.
   
   For more details on how to define a schema, see :ref:`enforce-a-schema`.

.. _sync-modes:
.. _enable-flexible-sync:

Procedure
---------

.. include:: /includes/note-flexible-sync-prerequisite.rst

.. tabs-realm-admin-interfaces::

   .. tab::
      :tabid: ui
      
      .. procedure::

         .. step:: Navigate to the Device Sync Configuration Screen

            To define Device Sync rules and enable Device Sync for your application, navigate to the
            :guilabel:`Device Sync` configuration screen through the {+leftnav+}.

         .. step:: Specify Your Sync Settings

            Follow the prompts to configure Device Sync. For details on the
            available configuration settings, refer to :ref:`sync-settings`.

         .. step:: Turn On Sync

            Click :guilabel:`Enable Sync`, take note of any
            recommendations that appear and then confirm your choice.

     
   .. tab::
      :tabid: cli
      
      .. procedure::

         .. step:: Pull the Latest Version of Your App

            To update your app through the CLI, you need an :ref:`up-to-date application
            directory <application-directory>`. To pull a local copy of the latest version
            of your app, run the following:

            .. code-block:: bash

               realm-cli pull --remote="<Your App ID>"

         .. step:: Add a Sync Configuration

            You can enable sync for a single linked cluster in your application.
            If you have not yet linked the cluster to your application, follow the
            :ref:`link-a-data-source` guide first.

            The App Services App has a ``sync`` directory where you can find 
            the :ref:`sync configuration file <appconfig-sync>`. If you have not 
            yet enabled Sync, this directory is empty.

            Add a ``config.json`` similar to:

            .. code-block:: json

               {
                 "type": "flexible",
                 "development_mode_enabled": <Boolean>,
                 "service_name": "<Data Source Name>",
                 "database_name": "<Development Mode Database Name>",
                 "state": <"enabled" | "disabled">,
                 "client_max_offline_days": <Number>,
                 "is_recovery_mode_disabled": <Boolean>,
                 "permissions": {
                   "rules": {
                     "<Type Name>": [
                       {
                         "name": <String>,
                         "applyWhen": <Expression>,
                         "read": <Expression>,
                         "write": <Expression>,
                         "fields": {
                           "<Field Name>": {
                             "read": <Boolean>,
                             "write": <Boolean>,
                             "fields": <Embedded Object Fields>
                           }
                         }
                         "additional_fields": {
                           "read": <Boolean>,
                           "write": <Boolean>
                         }
                       }
                     ]
                   },
                   "defaultRoles": [
                     {
                       "name": <String>,
                       "applyWhen": { <Expression> },
                       "read": <Expression>,
                       "write": <Expression>
                     }
                   ]       
                 },
                 "queryable_fields_names": <Array of String Field Names>
               }
               
            For details, refer to the :ref:`sync-configuration-reference`.

         .. step:: Deploy the Sync Configuration

            Deploy your changes to start syncing data and enforcing Device Sync
            rules. Import your app configuration:

            .. code-block:: shell

               realm-cli push --remote="<Your App ID>"
     
   .. tab::
      :tabid: api
      
      .. procedure::

         .. step:: Select a Cluster to Sync

            You can enable Device Sync for a single linked cluster in your
            application. If you have not yet linked the cluster to your
            application, follow the :ref:`link-a-data-source` guide.

            .. note:: Authenticating Your Request with an Access Token

              To authenticate your request to the App Services Admin API, you need a valid and
              current authorization token from the MongoDB Cloud API. Read the
              :admin-api-endpoint:`API Authentication <section/Get-Authentication-Tokens>`
              documentation to learn how to acquire a valid access token.

            You'll need the cluster's service configuration file to configure sync. You
            can find the configuration file by :admin-api-endpoint:`listing all services 
            through the Admin API <operation/adminListServices>`:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services \
                 -X GET \
                 -h 'Authorization: Bearer <Valid Access Token>'

            Identify the service whose configuration you need to update to enable
            Sync. If you have accepted the default names when configuring 
            your App, this should be a service whose ``name`` is ``mongodb-atlas``
            and ``type`` is ``mongodb-atlas``. You need this service's ``_id``.

            Now you can :admin-api-endpoint:`get the configuration file for 
            this service <operation/adminGetServiceConfig>`:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services/{MongoDB_Service_ID}/config \
                 -X GET \
                 -h 'Authorization: Bearer <Valid Access Token>'

            Once you have the configuration, add the ``flexible_sync`` object with the
            following template configuration:

            .. code-block:: json

               {
                 ...
                 "flexible_sync": {
                   "state": "enabled",
                   "database_name": "<Name of Database>",
                   "permissions": {
                     "defaultRoles": [
                       {
                         "applyWhen": {},
                         "name": "all",
                         "read": true,
                         "write": true
                       }
                     ],
                     "rules": {}
                   },
                   "queryable_fields_names": <Array of String Field Names>,
                   "client_max_offline_days": <Number>,
                   "is_recovery_mode_disabled": <Boolean>
                 }
                 ...
               }

            For details, refer to the :ref:`sync-configuration-reference`.

         .. step:: Deploy the Sync Configuration

            To deploy your changes to start syncing data and enforcing Device
            Sync rules, send an :admin-api-endpoint:`Admin API request
            <operation/adminGetServiceConfig>` that updates the cluster
            configuration with your sync configuration:

            .. note:: Authenticating Your Request with an Access Token

              To authenticate your request to the App Services Admin API, you need a valid and
              current authorization token from the MongoDB Cloud API. Read the
              :admin-api-endpoint:`API Authentication <section/Get-Authentication-Tokens>`
              documentation to learn how to acquire a valid access token.

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services/{MongoDB_Service_ID}/config \
                 -X PATCH \
                 -h 'Authorization: Bearer <Valid Access Token>' \
                 -h "Content-Type: application/json"
                 -d @/sync/config.json
