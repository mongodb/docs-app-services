.. _enable-realm-sync:
.. _enable-sync:

========================
Enable Atlas Device Sync
========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

You can enable Atlas Device Sync via the {+app+} UI, {+cli+}, or the 
Atlas App Services Admin API. If it is your first time enabling Device Sync, 
the UI is a great choice because it walks you through the required steps.

If you're re-enabling it after pausing or terminating it, see: 
:ref:`Resume <resume-sync>` or :ref:`Re-Enable <re-enable-realm-sync>` 
Device Sync.

Prerequisites
-------------

While you are configuring Device Sync, you must define the data access patterns
and rules for your {+app+}. If you haven't already decided how you want to 
configure your data model and access Device Sync, see:

- :ref:`Configure Your Data Model <sync-schema-overview>`
- :ref:`Choose Your Sync Mode <sync-modes>`
- :ref:`Sync Rules and Permissions <sync-permissions>`

.. important::
   
   Before defining sync rules and enabling sync, you must specify at least
   one valid :ref:`schema <schemas>` for a collection in the synced cluster 
   unless you are using :ref:`Development Mode <enable-development-mode>`.
   
   At a minimum, the schema must define ``_id`` and the field that you intend to
   use as your :ref:`partition key <partition-key>` or :ref:`queryable field 
   <queryable-fields>`.
   
   For more details on how to define a schema, see :ref:`enforce-a-schema`.

.. _enable-pbs-sync:

Enable Partition-Based Sync
---------------------------

.. tabs-realm-admin-interfaces::

   .. tab::
      :tabid: ui
      
      .. procedure::

         .. step:: Navigate to the Sync Configuration Screen

            To define Device Sync rules and enable Device Sync for your application, navigate to the
            :guilabel:`Sync` configuration screen through the {+leftnav+}.

            .. note:: Sync Rules Cannot Change

               You define Device Sync rules at the same time as you enable Device Sync. Once Device Sync is
               enabled, you can't change your app's Device Sync rules unless you terminate Device Sync
               and re-enable it with new rules.


         .. step:: Select Development Details

            You can enable Device Sync for a single linked cluster in your application.
            Determine which cluster you want to use and then select it from the
            :guilabel:`Select a Cluster To Sync` dropdown menu.

            .. figure:: /images/define-sync-rules-select-cluster.png
               :width: 750px
               :alt: The cluster selection dropown menu


         .. step:: Choose a Partition Key

            The Device Sync partition key is a field in every synced document that maps
            each document to a client-side realm. Device Sync rules apply at the partition
            level, so it's particularly important to consider your data model and access
            patterns. For more information on partition keys and how to choose one, see
            :ref:`Partitions <sync-partitions>`.

            .. note::

              The partition key can either be required or optional. If the partition key
              field is optional, then all MongoDB documents that either exclude the
              partition key or have a null value for the partition key will be sent to the
              null partition. If the partition key field is required, Device Sync
              ignores any MongoDB documents that lack a valid value for the partition
              key. We recommend a required partition key unless you want to Device Sync
              pre-existing data with invalid or missing partition values from a
              MongoDB collection.


         .. step:: Define Read & Write Permissions

            The :guilabel:`Define Permissions` section allows you to define :ref:`JSON
            expressions <expressions>` that App Services dynamically evaluates to determine a
            user's read and write permissions for the data in a given partition.

            Device Sync rule expressions have access to :json-expansion:`%%user`, which resolves
            to the user that opened the realm, and :json-expansion:`%%partition`, which
            resolves to the partition key value for the realm. You can also use operators,
            including :json-operator:`%function`, to handle more complex cases. For
            examples, see :ref:`sync-permissions`.

            Once you've determined how to decide a user's read and write permissions for a
            given partition, define the corresponding JSON expressions in the
            :guilabel:`Read` and :guilabel:`Write` inputs.

            .. figure:: /images/define-sync-rules-permissions.png
               :width: 750px
               :alt: The partition read and write expression inputs

         .. step:: Check Default Advanced Configuration Behaviors

            Expand the :guilabel:`Advanced Configuration` section.

            App Services Apps provide advanced optimization features 
            that are enabled by default:

            - :ref:`Client Max Offline Time <client-maximum-offline-time>`
            - :ref:`Client Recovery <recover-unsynced-changes>`

            If you want to change the length of time that a client can be 
            offline, or disable either of these features, you can do so 
            in the :guilabel:`Advanced Configuration` section.

         .. step:: Turn On Sync

            Now that you've configured rules for your synced cluster, all that's left to
            do is turn on Device Sync for client applications. Click :guilabel:`Enable Sync`,
            take note of any recommendations that appear, and then confirm your choice.

     
   .. tab::
      :tabid: cli

      This procedure assumes you have :ref:`created an App Services App 
      <create-app-cli>` and have linked a data source.

      If you have not yet linked the cluster to your application, follow the
      :ref:`link-a-data-source` guide to link it before
      you continue.
      
      .. procedure::

         .. step:: Pull the Latest Version of Your App

            To update your app through the CLI, you need an :ref:`up-to-date application
            directory <application-directory>`. To pull a local copy of the latest version
            of your app, run the following:

            .. code-block:: bash

               realm-cli pull --remote="<Your App ID>"


         .. step:: Add a Sync Configuration

            You can enable sync for a single linked cluster in your application.
            If you have not yet linked the cluster to your application, follow the
            :ref:`link-a-data-source` guide to link it before
            you continue.

            The App Services App has a ``sync`` directory where you can find 
            the :ref:`sync configuration file <appconfig-sync>`. If you have not 
            yet enabled Sync, this directory is empty.

            Add a ``config.json`` similar to:

            .. code-block:: json

               {
                 "type": "partition",
                 "state": <"enabled" | "disabled">,
                 "development_mode_enabled": <Boolean>,
                 "service_name": "<Data Source Name>",
                 "database_name": "<Database Name>",
                 "partition": {
                   "key": "<Partition Key Field Name>",
                   "type": "<Partition Key Type>",
                   "permissions": {
                     "read": { <Expression> },
                     "write": { <Expression> }
                   }
                 },
                 "client_max_offline_days": <Number>,
                 "is_recovery_mode_disabled": <Boolean>
               }

         .. step:: Choose a Partition Key

            The sync partition key is a field in every synced document that maps
            each document to a client-side realm. Sync rules apply at the partition level,
            so it's particularly important to consider your data model and access
            patterns. For more information on partition keys and how to choose one, see
            :ref:`Partitions <sync-partitions>`.

            .. note::

              The partition key can either be required or optional. If the partition key
              field is optional, then all MongoDB documents that either exclude the
              partition key or have a null value for the partition key will be sent to the
              null partition. If the partition key field is required, Device Sync
              ignores any MongoDB documents that lack a valid value for the partition
              key. We recommend a required partition key unless you want to sync
              pre-existing data with invalid or missing partition values from a
              MongoDB collection.

            Once you have decided which field to use, update ``sync.partition``
            with the partition key field name in the ``key`` field and the partition key
            type in the ``type`` field, similar to:

            .. code-block:: json
               :emphasize-lines: 4, 5

               {
                 ...
                 "partition": {
                   "key": "owner_id",
                   "type": "string",
                   "permissions": {
                     "read": {},
                     "write": {}
                   }
                 }
                 ...
               }

         .. step:: Define Read & Write Permissions

            App Services allows you to define :ref:`JSON expressions <expressions>` that it
            dynamically evaluates whenever a user opens a realm to determine if the user
            has read or write permissions for data in the partition.

            Sync rule expressions have access to :json-expansion:`%%user`, which resolves
            to the user that opened the realm, and :json-expansion:`%%partition`, which
            resolves to the partition key value for the realm. You can also use operators,
            including :json-operator:`%function`, to handle more complex cases. For
            examples, see :ref:`Sync Permissions <sync-permissions>`.

            Once you've determined how to decide a user's read and write permissions for a
            given partition, define the corresponding JSON expressions in the
            ``read`` and ``write`` fields of ``partition.permissions``, similar to:

            .. code-block:: json
               :emphasize-lines: 7-15

               {
                 ...
                 "partition": {
                   "key": "owner_id",
                   "type": "string",
                   "permissions": {
                     "read": {
                       "$or": [
                         { "%%user.id": "%%partition" },
                         { "%%user.custom_data.shared": "%%partition" }
                       ]
                     },
                     "write": {
                       "%%user.id": "%%partition"
                     }
                   }
                 }
                 ...
               }

         .. step:: Specify Values for Sync Optimization

            Sync provides features that enable you to optimize Sync 
            performance and improve the data recovery process on the client. 
            These features are represented by additional settings:

            - ``client_max_offline_days``
            - ``is_recovery_mode_disabled``

            You can set a numerical value for ``client_max_offline_days``.
            When you enable Sync via the App Services UI, the default 
            value is ``30``, which represents 30 days. 
            
            For more information, see: :ref:`client-maximum-offline-time`.

            Recovery Mode enables Sync to attempt to recover data that 
            has not yet been synced when a client reset occurs. When you 
            enable Sync via the App Services UI, Recovery Mode is enabled 
            by default. We recommend enabling Recovery Mode for automatic 
            client reset handling. If you have disabled recovery mode and 
            want to re-enable it, set ``is_recovery_mode_disabled`` to ``false``.
            
            For more information, see: :ref:`recover-unsynced-changes`.

            .. code-block:: json
               :emphasize-lines: 10-11

               {
                 "type": "partition",
                 "state": "enabled",
                 "development_mode_enabled": true,
                 "service_name": "mongodb-atlas",
                 "database_name": "my-test-database",
                 "partition": {
                   ...
                 },
                 "client_max_offline_days": 30,
                 "is_recovery_mode_disabled": false
               }

         .. step:: Deploy the Sync Configuration

            Now that you've defined the sync configuration, including read and write
            permissions, you can deploy your changes to start syncing data and enforcing
            sync rules.

            To deploy your changes, import your app configuration to your App Services App:

            .. code-block:: shell

               realm-cli push --remote="<Your App ID>"
     
   .. tab::
      :tabid: api
      
      .. procedure::

         .. step:: Select a Cluster to Sync

            You can enable Sync for a single linked cluster in your application.
            If you have not yet linked the cluster to your application, follow the
            :ref:`link-a-data-source` guide to link it before
            you continue.

            You'll need the cluster's service configuration file to configure sync. You
            can find the configuration file by :admin-api-endpoint:`listing all services 
            through the Admin API <operation/adminListServices>`:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services \
                 -X GET \
                 -h 'Authorization: Bearer <Valid Access Token>'

            Identify the service whose configuration you need to update to enable
            Sync. If you have accepted the default names when configuring 
            your App, this should be a service whose ``name`` is ``mongodb-atlas``
            and ``type`` is ``mongodb-atlas``. You need this service's ``_id``.

            Now you can :admin-api-endpoint:`get the configuration file for 
            this service <operation/adminGetServiceConfig>`:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services/{MongoDB_Service_ID}/config \
                 -X GET \
                 -h 'Authorization: Bearer <Valid Access Token>'

            Once you have the configuration, add the ``sync`` object with the
            following template configuration:

            .. code-block:: json

               {
                 ...
                 "sync": {
                   "type": "partition",
                   "state": "enabled",
                   "development_mode_enabled": <Boolean>,
                   "database_name": "<Database Name>",
                   "partition": {
                     "key": "<Partition Key Field Name>",
                     "type": "<Partition Key Type>",
                     "permissions": {
                       "read": { <Expression> },
                       "write": { <Expression> }
                     }
                   },
                   "client_max_offline_days": <Number>,
                   "is_recovery_mode_disabled": <Boolean>
                 }
                 ...
               }

         .. step:: Choose a Partition Key

            The sync partition key is a field in every synced document that maps
            each document to a client-side realm. Sync rules apply at the partition level,
            so it's particularly important to consider your data model and access
            patterns. For more information on partition keys and how to choose one, see
            :ref:`Partitions <sync-partitions>`.

            You can :admin-api-endpoint:`get a list of all valid partition 
            keys <operation/adminGetSync>` and their corresponding types 
            through the Admin API:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/sync/data?service_id=<MongoDB Service ID> \
                 -X GET \
                 -h 'Authorization: Bearer <Valid Access Token>'

            .. note::

              The partition key can either be required or optional. If the partition key
              field is optional, then all MongoDB documents that either exclude the
              partition key or have a null value for the partition key will be sent to the
              null partition. If the partition key field is required, Device Sync
              ignores any MongoDB documents that lack a valid value for the partition
              key. We recommend a required partition key unless you want to sync
              pre-existing data with invalid or missing partition values from a
              MongoDB collection.

            Once you have decided which field to use, update ``sync.partition``
            with the partition key field name in the ``key`` field and the partition key
            type in the ``type`` field.

            .. code-block:: json
               :emphasize-lines: 9-10

               {
                 ...
                 "sync": {
                   "type": "partition",
                   "state": "enabled",
                   "development_mode_enabled": <Boolean>,
                   "database_name": "<Database Name>",
                   "partition": {
                     "key": "owner_id",
                     "type": "string",
                     "permissions": {
                       "read": { <Expression> },
                       "write": { <Expression> }
                     }
                   },
                   "client_max_offline_days": <Number>,
                   "is_recovery_mode_disabled": <Boolean>
                 }
                 ...
               }

         .. step:: Define Read & Write Permissions

            App Services allows you to define :ref:`JSON expressions <expressions>` that it
            dynamically evaluates whenever a user opens a realm to determine if the user
            has read or write permissions for data in the partition.

            Sync rule expressions have access to :json-expansion:`%%user`, which resolves
            to the user that opened the realm, and :json-expansion:`%%partition`, which
            resolves to the partition key value for the realm. You can also use operators,
            including :json-operator:`%function`, to handle more complex cases. For
            examples, see :ref:`Sync Permissions <sync-permissions>`.

            Once you've determined how to decide a user's read and write permissions for a
            given partition, define the corresponding JSON expressions in the
            ``read`` and ``write`` fields of ``sync.partition.permissions``.

            .. code-block:: json
               :emphasize-lines: 12-20

               {
                 ...
                 "sync": {
                   "type": "partition",
                   "state": "enabled",
                   "development_mode_enabled": <Boolean>,
                   "database_name": "<Database Name>",
                   "partition": {
                     "key": "owner_id",
                     "type": "string",
                     "permissions": {
                       "read": {
                         "$or": [
                           { "%%user.id": "%%partition" },
                           { "%%user.custom_data.shared": "%%partition" }
                         ]
                       },
                       "write": {
                         "%%user.id": "%%partition"
                       }
                     }
                   },
                   "client_max_offline_days": <Number>,
                   "is_recovery_mode_disabled": <Boolean>
                 }
                 ...
               }

         .. step:: Specify Values for Sync Optimization

            Sync provides features that enable you to optimize Sync 
            performance and improve the client data recovery process. These 
            features are represented by additional settings:

            - ``client_max_offline_days``
            - ``is_recovery_mode_disabled``

            You can set a numerical value for ``client_max_offline_days``.
            When you enable Sync via the App Services UI, the default 
            value is ``30``, which represents 30 days. 
            
            For more information, see: :ref:`client-maximum-offline-time`.

            Recovery Mode enables Sync to attempt to recover unsynced data 
            when a client reset occurs. When you enable Sync via the App 
            Services UI, Recovery Mode is enabled by default. We recommend
            enabling Recovery Mode for automatic client reset handling.
            To enable Recovery Mode, set ``is_recovery_mode_disabled`` to 
            ``false``.
            
            For more information, see: :ref:`recover-unsynced-changes`.

            .. code-block:: json
               :emphasize-lines: 11-12

               {
                 ...
                 "sync": {
                   "type": "partition",
                   "state": "enabled",
                   "development_mode_enabled": true,
                   "database_name": "my-test-database",
                   "partition": {
                     ...
                   },
                   "client_max_offline_days": 30,
                   "is_recovery_mode_disabled": false
                 }
                 ...
               }

         .. step:: Deploy the Sync Configuration

            Now that you've defined the sync configuration, including read and write
            permissions, you can deploy your changes to start syncing data and enforcing
            sync rules.

            To deploy your changes, send an :admin-api-endpoint:`Admin API request that updates the cluster
            configuration with your sync configuration <operation/adminGetServiceConfig>`:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services/{MongoDB_Service_ID}/config \
                 -X PATCH \
                 -h 'Authorization: Bearer <Valid Access Token>' \
                 -d @/sync/config.json

.. _enable-flexible-sync:

Enable Flexible Sync
--------------------

.. include:: /includes/note-flexible-sync-prerequisite.rst

.. tabs-realm-admin-interfaces::

   .. tab::
      :tabid: ui
      
      .. procedure::

         .. step:: Navigate to the Device Sync Configuration Screen

            To define Device Sync rules and enable Device Sync for your application, navigate to the
            :guilabel:`Device Sync` configuration screen through the {+leftnav+}.


         .. step:: Select Development Details

            Under the :guilabel:`Select Development Details` heading, you can configure
            various development details, such as Device Sync types, Development Mode,
            and a cluster to Device Sync.

            Below the :guilabel:`Device Sync types` subheading, select the :guilabel:`Flexible`
            option to enable Flexible Sync.

            Next, under the :guilabel:`Development Mode` subheading, you can choose to
            toggle :ref:`Development Mode <enable-disable-development-mode>` on/off.
            Enabling ``Development Mode`` allows you to define schemas directly in your
            client application code and is suitable if you are in development and do not
            have application data in Atlas yet.

            Finally, you can enable Device Sync for a single linked cluster in your
            application. Determine which cluster you want to use and select it from
            the :guilabel:`Select Cluster To Sync` dropdown menu.

            .. important:: Ineligible Clusters

               Flexible Sync requires MongoDB 5.0. Clusters display as gray and not-selectable
               in the UI when they do not meet the requirements for Flexible Sync.

            .. figure:: /images/flex-sync-select-development-details.png
               :width: 750px
               :alt: Select Development Details Menu


         .. step:: Select Queryable Fields

            When configuring Flexible Sync, specify one or more :ref:`queryable
            fields <queryable-fields>` from your Sync Schema.

            To configure queryable fields for your application, navigate to the
            :guilabel:`Select Queryable Fields` heading. Select up to 10 existing fields
            from your schema to query on. If you want to create a new field(s) to
            construct a query on, you must define a database and enable ``Development Mode``.

            .. figure:: /images/flex-sync-set-queryable-fields.png
               :width: 750px
               :alt: Select Queryable Fields


         .. step:: Define Read & Write Permissions

            In the :guilabel:`Define Permissions` section, you can define the session
            roles and rules for your app.

            For details, see :ref:`flexible-sync-rules-and-permissions`.

            .. figure:: /images/flex-sync-define-permissions.png
               :width: 750px
               :alt: Define Permissions Settings


         .. step:: Configure Asymmetric Sync (Optional)

            1. Expand the :guilabel:`Advanced Configuration` section.

            #. The dropdown under the :guilabel:`Asymmetric Sync` heading shows the
               collections that you can select for this Asymmetric Sync. When you select a
               collection, it is listed below the dropdown.

               .. figure:: /images/asymmetric-sync.png
                  :alt: Select Asymmetric Sync collections

            #. If you have Dev Mode enabled, you can also create a new collection. When you
               select the dropdown, you can type in the name of the new collection, and
               App Services creates the collection automatically.


         .. step:: Turn On Sync

            Now that you've configured rules for your synced cluster, all that's left to
            do is turn on Device Sync for client applications. Click :guilabel:`Enable Device Sync`,
            take note of any recommendations that appear and then confirm your choice.

     
   .. tab::
      :tabid: cli
      
      .. procedure::

         .. step:: Pull the Latest Version of Your App

            To update your app through the CLI, you need an :ref:`up-to-date application
            directory <application-directory>`. To pull a local copy of the latest version
            of your app, run the following:

            .. code-block:: bash

               realm-cli pull --remote="<Your App ID>"

         .. step:: Add a Sync Configuration

            You can enable sync for a single linked cluster in your application.
            If you have not yet linked the cluster to your application, follow the
            :ref:`link-a-data-source` guide to link it before
            you continue.

            The App Services App has a ``sync`` directory where you can find 
            the :ref:`sync configuration file <appconfig-sync>`. If you have not 
            yet enabled Sync, this directory is empty.

            Add a ``config.json`` similar to:

            .. code-block:: json

               {
                 "type": "flexible",
                 "development_mode_enabled": <Boolean>,
                 "service_name": "<Data Source Name>",
                 "database_name": "<Development Mode Database Name>",
                 "state": <"enabled" | "disabled">,
                 "client_max_offline_days": <Number>,
                 "is_recovery_mode_disabled": <Boolean>,
                 "permissions": {
                   "rules": {
                     "<Type Name>": [
                       {
                         "name": <String>,
                         "applyWhen": { <Expression> },
                         "read": <Expression>,
                         "write": <Expression>,
                         "fields": {
                           "<Field Name>": {
                             "read": <Boolean>,
                             "write": <Boolean>,
                             "fields": <Embedded Object Fields>
                           }
                         }
                         "additional_fields": {
                           "read": <Boolean>,
                           "write": <Boolean>
                         }
                       }
                     ]
                   },
                   "defaultRoles": [
                     {
                       "name": <String>,
                       "applyWhen": { <Expression> },
                       "read": <Expression>,
                       "write": <Expression>
                     }
                   ]       
                 },
                 "queryable_fields_names": [
                   <Array of String Field Names>
                 ]
               }

         .. step:: Choose Queryable Fields

            The ``queryable_fields_names`` property allows you to define a set of
            queryable fields for the device should query on.

            To learn more about queryable fields, such as eligible field types, 
            reserved field names, and performance implications, see the 
            :ref:`queryable fields <queryable-fields>` documentation.

            .. code-block:: json
               :emphasize-lines: 12-14

               {
                 "type": "flexible",
                 "development_mode_enabled": <Boolean>,
                 "service_name": "<Data Source Name>",
                 "database_name": "<Development Mode Database Name>",
                 "state": <"enabled" | "disabled">,
                 "client_max_offline_days": <Number>,
                 "is_recovery_mode_disabled": <Boolean>,
                 "permissions": {
                   ... 
                 },
                 "queryable_fields_names": [
                   ["age", "name"]
                 ]
               }

         .. step:: Define Read & Write Permissions

            In the ``flexible_sync`` configuration field, you can define the session roles
            and rules for your app.

            For details, see :ref:`flexible-sync-rules-and-permissions`.

            In the following example, there is a user-defined role in the ``Employees``
            collection. This role takes precedent, and the default role is not applied for
            the ``Employees`` collection. However, since the ``Items`` collection does not
            specify a value, App Services will apply the default role to the ``Items`` collection.

            .. code-block:: json
               :emphasize-lines: 5-24

               {
                 "type": "flexible",
                 ...
                 "permissions": {
                   "Employees": {
                     "roles": [
                       {
                         "name": "everyone",
                         "applyWhen": {},
                         "read": { "owner_id": "%%user.id" },
                           "write": false
                         }
                     ]
                   },
                   "Items": {},
                   "defaultRoles": [
                     {
                       "applyWhen": {},
                       "name": "all",
                       "read": true,
                       "write": true
                     }
                    ],
                   "rules": {}
                 },
                 "queryable_fields_names": ["age", "name"]
               }

         .. step:: Specify Values for Sync Optimization

            Sync provides features that enable you to optimize Sync 
            performance and improve the client data recovery process. These 
            features are represented by additional settings:

            - ``client_max_offline_days``
            - ``is_recovery_mode_disabled``

            You can set a numerical value for ``client_max_offline_days``.
            When you enable Sync via the App Services UI, the default 
            value is ``30``, which represents 30 days. 
            
            For more information, see: :ref:`client-maximum-offline-time`.

            Recovery Mode enables Sync to attempt to recover unsynced data 
            when a client reset occurs. When you enable Sync via the App 
            Services UI, Recovery Mode is enabled by default. We recommend
            enabling Recovery Mode for automatic client reset handling.
            To enable Recovery Mode, set ``is_recovery_mode_disabled`` to 
            ``false``.
            
            For more information, see: :ref:`recover-unsynced-changes`.

            Specify the values for these settings:

            .. code-block:: json
               :emphasize-lines: 4-5

               {
                 "type": "flexible",
                 ...
                 "client_max_offline_days": 30,
                 "is_recovery_mode_disabled": false,
                 "permissions": {
                   ... 
                 },
                 "queryable_fields_names": [
                   ["age", "name"]
                 ]
               }

         .. step:: Deploy the Sync Configuration

            Now that you've defined the Device Sync configuration, you can 
            deploy your changes to start syncing data and enforcing
            Device Sync rules.

            To deploy your changes, import your app configuration:

            .. code-block:: shell

               realm-cli push --remote="<Your App ID>"
     
   .. tab::
      :tabid: api
      
      .. procedure::

         .. step:: Select a Cluster to Sync

            You can enable Device Sync for a single linked cluster in your application.
            If you have not yet linked the cluster to your application, follow the
            :ref:`link-a-data-source` guide to link it before
            you continue.

            .. note:: Authenticating Your Request with an Access Token

              To authenticate your request to the App Services Admin API, you need a valid and
              current authorization token from the MongoDB Cloud API. Read the
              :admin-api-endpoint:`API Authentication <section/Get-Authentication-Tokens>`
              documentation to learn how to acquire a valid access token.

            You'll need the cluster's service configuration file to configure sync. You
            can find the configuration file by :admin-api-endpoint:`listing all services 
            through the Admin API <operation/adminListServices>`:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services \
                 -X GET \
                 -h 'Authorization: Bearer <Valid Access Token>'

            Identify the service whose configuration you need to update to enable
            Sync. If you have accepted the default names when configuring 
            your App, this should be a service whose ``name`` is ``mongodb-atlas``
            and ``type`` is ``mongodb-atlas``. You need this service's ``_id``.

            Now you can :admin-api-endpoint:`get the configuration file for 
            this service <operation/adminGetServiceConfig>`:

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services/{MongoDB_Service_ID}/config \
                 -X GET \
                 -h 'Authorization: Bearer <Valid Access Token>'

            Once you have the configuration, add the ``flexible_sync`` object with the
            following template configuration:

            .. code-block:: json

               {
                 ...
                 "flexible_sync": {
                   "state": "enabled",
                   "database_name": "",
                   "permissions": {
                     "defaultRoles": [
                       {
                         "applyWhen": {},
                         "name": "all",
                         "read": true,
                         "write": true
                       }
                     ],
                     "rules": {}
                   },
                   "queryable_fields_names": [],
                   "client_max_offline_days": <Number>,
                   "is_recovery_mode_disabled": <Boolean>
                 }
                 ...
               }

            Replace the ``database_name`` field's value with the name of your database.

            .. note::

              The default role applies to any collection where you do not define custom roles.
              Since no custom roles are defined in the above example, the default role
              applies to all collections. For more information, see: 
              :ref:`Default Roles <default-roles>`.

         .. step:: Choose Queryable Fields

            The ``queryable_fields_names`` property defines a set of queryable 
            fields that the device may query on. 
            
            To learn more about queryable fields, such as eligible field types, 
            reserved field names, and performance implications, see the 
            :ref:`queryable fields <queryable-fields>` documentation.

            Add the fields you would like your application to query on to 
            the ``flexible_sync.queryable_fields_names``:

            .. code-block:: json
               :emphasize-lines: 17

               {
                ...
                 "flexible_sync": {
                   "state": "enabled",
                   "database_name": "",
                   "permissions": {
                     "defaultRoles": [
                       {
                         "applyWhen": {},
                         "name": "all",
                         "read": true,
                         "write": true
                       }
                     ],
                     "rules": {}
                   },
                   "queryable_fields_names": ["age", "name"],
                   "client_max_offline_days": <Number>,
                   "is_recovery_mode_disabled": <Boolean>
                 }
                 ...
               }

         .. step:: Define Read & Write Permissions

            In the ``flexible_sync`` configuration field, you can define the session roles
            and rules for your app.

            For details, see :ref:`flexible-sync-rules-and-permissions`.

            In the following example, there is a user-defined role in the ``Employees``
            collection. This role takes precedent, and the default role is not applied for
            the ``Employees`` collection. However, since the ``Items`` collection does not
            specify a value, App Services will apply the default role to the ``Items`` collection.

            .. code-block:: json
               :emphasize-lines: 7-26

               {
                 ...
                 "flexible_sync": {
                   "state": "enabled",
                   "database_name": "test-database",
                   "permissions": {
                     "Employees": {
                       "roles": [
                         {
                           "name": "everyone",
                           "applyWhen": {},
                           "read": { "owner_id": "%%user.id" },
                           "write": false
                         }
                       ]
                     },
                     "Items": {},
                     "defaultRoles": [
                       {
                         "applyWhen": {},
                         "name": "all",
                         "read": true,
                         "write": true
                       }
                     ],
                     "rules": {}
                   },
                   "queryable_fields_names": ["age", "name"],
                   "client_max_offline_days": <Number>,
                   "is_recovery_mode_disabled": <Boolean>
                 }
                 ...
               }

         .. step:: Specify Values for Sync Optimization

            Sync provides features that enable you to optimize Sync 
            performance and improve the client data recovery process. These 
            features are represented by additional settings:

            - ``client_max_offline_days``
            - ``is_recovery_mode_disabled``

            You can set a numerical value for ``client_max_offline_days``.
            When you enable Sync via the App Services UI, the default 
            value is ``30``, which represents 30 days. 
            
            For more information, see: :ref:`client-maximum-offline-time`.

            Recovery Mode enables Sync to attempt to recover unsynced data 
            when a client reset occurs. When you enable Sync via the App 
            Services UI, Recovery Mode is enabled by default. We recommend
            enabling Recovery Mode for automatic client reset handling.
            To enable Recovery Mode, set ``is_recovery_mode_disabled`` to 
            ``false``.
            
            For more information, see: :ref:`recover-unsynced-changes`.

            Specify the values for these settings:

            .. code-block:: json
               :emphasize-lines: 10-11

               {
                 ...
                 "flexible_sync": {
                   "state": "enabled",
                   "database_name": "test-database",
                   "permissions": {
                     ...
                   },
                   "queryable_fields_names": ["age", "name"],
                   "client_max_offline_days": 30,
                   "is_recovery_mode_disabled": false
                 }
                 ...
               }

         .. step:: Deploy the Sync Configuration

            Now that you've defined the Device Sync configuration, including read and write
            permissions, you can deploy your changes to start syncing data and enforcing
            Device Sync rules.

            To deploy your changes, send an :admin-api-endpoint:`Admin API 
            request <operation/adminGetServiceConfig>` that updates the 
            cluster configuration with your sync configuration:

            .. note:: Authenticating Your Request with an Access Token

              To authenticate your request to the App Services Admin API, you need a valid and
              current authorization token from the MongoDB Cloud API. Read the
              :admin-api-endpoint:`API Authentication <section/Get-Authentication-Tokens>`
              documentation to learn how to acquire a valid access token.

            .. code-block:: shell

               curl https://realm.mongodb.com/api/admin/v3.0/groups/{GROUP_ID}/apps/{APP_ID}/services/{MongoDB_Service_ID}/config \
                 -X PATCH \
                 -h 'Authorization: Bearer <Valid Access Token>' \
                 -h "Content-Type: application/json"
                 -d @/sync/config.json
