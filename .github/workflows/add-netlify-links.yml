name: Add Netlify Links To Changed Pages
on:
    workflow_call:
    pull_request:
jobs:
    get-pr-changes:
        name: Get Changed Files
        runs-on: ubuntu-latest
        permissions:
            issues: write
            contents: write
            pull-requests: write
            repository-projects: write
        outputs:
            staging_links: ${{ steps.build_page_links.outputs.staging_links }}
        steps:
          - uses: actions/checkout@v4
          - name: Get changed files
            id: changed-files
            uses: tj-actions/changed-files@v44
            with:
              separator: ","
              files: source/**
          - name: Build Netlify Links for Changed Pages
            id: build_page_links
            run: |
                MY_STRING=$(cat << EOF
                first line
                second line
                third line
                EOF
                )
                MY_STRING="${MY_STRING//'%'/'%25'}"
                MY_STRING="${MY_STRING//$'\n'/'%0A'}"
                MY_STRING="${MY_STRING//$'\r'/'%0D'}"
                echo "staging_links=${MY_STRING}" >> "$GITHUB_OUTPUT"
    update-pr-description:
        name: Update the PR Description
        needs: get-pr-changes
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Set environment variable
              run: |
                pl=$(echo "${{ needs.get-pr-changes.outputs.staging_links }}"
                echo "${pl}"
            - name: Debug
              id: parser
              run: |
               # pl=$(echo "${{ needs.get-pr-changes.outputs.staging_links }}" | tr ',' '\n')
                #echo "${pl}"
               # echo $LINKS_ENV
            - name: Update PR Description
              uses: nefrob/pr-description@v1.1.2
              with:
                  content: ${{ needs.get-pr-changes.outputs.staging_links }}
                  token: ${{ secrets.GITHUB_TOKEN }}